{% extends "dashboard/page_template.html" %}

{% block content %}

<div class="page-header">
  <h1>Your calculations <small>Review your simulations</small></h1>
</div>

<div id="user_calculations">

  <div class="alert alert-info" role="alert">Loading your calculations...</div>

</div>

{% endblock %}

{% block end_of_body_scripts %}
  <script>
    window.user = {};
    window.user.email = "{{user.email}}";
    window.user.id = "{{user.id}}";
    console.log("Stored logged in user details");

    $.get('/api/v1.0/calculations', 
      function (calculations) {

        window.calculations = calculations;

        if (calculations.calculations.length == 0) {
          $("#user_calculations").html("<h1>You don't have any calculations yet</h1><p>They'll appear here once you've set them up</p>");
        } else {

          var source = $("#user-calculations-template").html();
          var template = Handlebars.compile(source);

          $("#user_calculations").html(template(calculations));

          // Attach functions to 'Run...' buttons
          $(".run-calculation-button")
            .click(
              function(el) {
                $(this).button('loading');
                var calculation_id = $(this).data('calculation-id'); 
                console.log("Running calculation " + calculation_id); 
                tnt.run_calculation(calculation_id);
              }
            );

          // Attach Download links to 'download' buttons
          _($(".download-calculation-button"))
            .each(function(el) {
              var calculation_id = $(el).data('calculation-id'); 
              console.log("Attaching download link for calculation " + calculation_id);
              console.log(calculation_id);
              var this_calculation_download_url = '/media/' + calculation_id + '/' + calculation_id + '.mat';
              console.log(this_calculation_download_url);
              $(el).attr("href", this_calculation_download_url);
            }
          );

        }

      }
    ).done(function() {

        // Attach functionality to various buttons
        $(".update_calculation_name_btn").click(
            function() {

                var calculation_id = $(this).data("calculation-id");

                var new_name_input = $(this)
                    .closest('.update_name_div')
                    .find('input');

                var new_name = new_name_input 
                    .val();

                if (new_name != "") {

                    console.log("This button text: " + $(this).html());
                    $(this).html("Updating...");
                    $(this).addClass("updating_name");

                    console.log("Renaming setup for calculation " + calculation_id + " to " + new_name);

                    $.post(
                        '/api/v1.0/calculation/rename/' + calculation_id + '/' + new_name, 
                        function(data) {
                            if (data == "OK") {
                                $(new_name_input).attr("placeholder", new_name);
                                $(new_name_input).val("");
                            }
                            console.log(data); 
                        }
                    ).done(function() {
                        $(".update_calculation_name_btn").html("Update name");
                        $(".update_calculation_name_btn").removeClass("updating_name");
                    });

                }

            }
        );


        $(".btn-delete-calculation")
          .click(
            function() {

                var calculation_id = $(this).data("calculation-id");

                console.log("Deleting setup for calculation " + calculation_id);

                $.post(
                  '/api/v1.0/calculation/delete/' + calculation_id, 
                  function (data) { 
                    console.log(data); 
                  }
                ).done(function () {
                  window.location = '/';
                });

            }
        );
    });

    $("#sidebar_home").addClass("active");

  </script>

{% endblock %}

{% block handlebars_scripts %}

  {% include "dashboard/handlebars_templates/user_calculations_template.html" %}
      
{% endblock %}
